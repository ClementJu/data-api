# Data API

## Description

The data API is an API exposing endpoints that allow to store and retrieve conversational data.


## Starting the application

### 1. Using Docker

The easiest way of running the application is to go into the API directory

```cd API```

and run

```docker compose up``` to see the logs or ```docker compose up -d``` to run it silently in the background.

### 2. Using the command line

Make sure to install all the required dependencies. You can do it by going into the API directory

```cd API```

and running the following command if you're using ```pip```:

```pip3 install -r requirements.txt```

The app can then be started using

```python3 -m uvicorn app.main.app:app --reload```


## Calling the API

The above-mentioned instructions with run the app on the port 8000 of the local machine.

You can reach the Swagger documentation by accessing ```http://localhost:8000/docs```.


## Running tests

Tests are automatically run pre-commit. If you want to run them manually, go into the API directory using

```cd API```

and run

```python3 -m pytest```


## Endpoints

### ```POST``` - ```/data/:customerId/:dialogId```

Inserts data generated by a given user during a given dialog with the chatbot.

#### Path parameters

- ```customerId```: string
- ```dialogId```: string

#### Expected body

```
{
    "text": string,
    "language": string (case-insensitive)
}
```

#### Returns
```
{
  "text": string,
  "language": string,
  "id": integer,
  "customer_id": string,
  "dialog_id": string,
  "received_at_timestamp_utc": timestamp e.g. "2023-01-09T20:30:38.942Z"
}
```

#### Constraints
- The inserted data is temporarily saved and cannot be retrieved by ```GET``` - ```/data/(?language=:language|customerId=:customerId)``` if the customer has not given his consent yet, or if he refused consent.



### ```POST``` - ```/consents/:dialogId```

Gives or refuses consent for a given dialog ID. Method called at the end of a discussion.

If the consent is given, the corresponding data is saved and becomes available when getting data using ```GET``` - ```/data/(?language=:language|customerId=:customerId)```.

If the consent is refused, the corresponding data is deleted.

#### Path parameters

- ```dialogId```: string

#### Expected body

```true``` or ```false```

#### Returns
```
{
  "has_given_consent": boolean "true" or "false",
  "id": integer,
  "dialog_id": string,
  "received_at_timestamp_utc": timestamp e.g. "2023-01-09T20:31:38.316Z"
}
```

#### Constraints
- A consent decision cannot be given twice for a given ```dialogId```
- A consent cannot be given if conversational data has not been sent before for a given ```dialogId```


### ```GET``` - ```/data/(?language=:language|customerId=:customerId)```

Retrieves conversational data, for which consent was given by the customer. The returned data is filtered based on the optional query parameters, and sorted by most recent data first.

#### Query parameters

- ```language```: string (case-insensitive)
- ```customerId```: string

#### Returns

```
[
  {
    "text": string,
    "language": string,
    "id": integer,
    "customer_id": string,
    "dialog_id": string,
    "received_at_timestamp_utc": timestamp e.g. "2023-01-09T20:29:17.881Z"
  }
]
```


### ```GET``` - ```/health```

Checks whether the application is up and running.

#### Returns

Returns a status code ```200``` and a body ```Ok``` if it is the case.

## Additional features

### Logging

Every single request is logged, providing many pieces of information

```
[INFO] - [2023-01-09 23:19:19,021 52507:ThreadPoolExecutor-0_0] root -
         URL: http://localhost:8000/data/as/3r53,
         QUERY_PARAMS: ,
         PATH_PARAMS: {'customerId': 'as', 'dialogId': '3r53'},
         HEADERS: Headers({'host': 'localhost:8000', 'content-type': 'application/json', 'origin': 'http://localhost:8000',
                           'accept-encoding': 'gzip, deflate', 'connection': 'keep-alive', 'accept': 'application/json',
                           'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko)
                           Version/15.5 Safari/605.1.15',
                           'referer': 'http://localhost:8000/docs', 'content-length': '46', 'accept-language': 'fr-FR,fr;q=0.9'}),
         REQUEST_BODY: b'{\n  "text": "string",\n  "language": "string"\n}',
         RESPONSE_STATUS: 200,
         RESPONSE_BODY: b'{"text":"string","language":"string","id":3,"customer_id":"as","dialog_id":"3r53",
                           "received_at_timestamp_utc":"2023-01-09T22:19:19.013000"}',
         | logging_helper.py:17
```

### Pre-commit hooks

The pre-commit configuration located at the root of the directory runs the following steps in order to validate a commit:
```
autoflake................................................................Passed
Flake8...................................................................Passed
isort....................................................................Passed
mypy.....................................................................Passed
Trim Trailing Whitespace.................................................Passed
Fix End of Files.........................................................Passed
run tests................................................................Passed
```

If one or more of the steps fail, the files cannot be committed.

To activate these hooks
1) Install ```pre-commit```: https://pre-commit.com
2) Run ```pre-commit install```
